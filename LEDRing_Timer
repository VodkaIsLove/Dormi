#include <Adafruit_NeoPixel.h> // Libary for LED-Ring
#include <ESP8266WiFi.h>
#include <WiFiUdp.h>
#include <NTPClient.h>


const char *ssid     = "TrautesHeim2";
const char *password = "381042995584258722807627";

//Zeitverschiebung UTC <-> MEZ (Winterzeit) = 3600 Sekunden (1 Stunde)
//Zeitverschiebung UTC <-> MEZ (Sommerzeit) = 7200 Sekunden (2 Stunden)
const long utcOffsetInSeconds = 3600;

WiFiUDP ntpUDP;
NTPClient timeClient(ntpUDP, "pool.ntp.org", utcOffsetInSeconds);


#define LED_PIN D5 // Make sure this PIN is right!
#define BUTTON_RED_PIN D2 // Make sure this PIN is right!
#define BUTTON_BLACK_PIN D1 // Make sure this PIN is right!
#define STRIPSIZE 12


Adafruit_NeoPixel strip = Adafruit_NeoPixel(STRIPSIZE, LED_PIN, NEO_GRB + NEO_KHZ800);

int HELLIGKEIT = 20;

void setup() {
  Serial.begin(115200);

  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Ich verbinde mich mit dem Internet...");
  }
 
  Serial.println("Ich bin mit dem Internet verbunden!");

  timeClient.begin();

  pinMode(BUTTON_RED_PIN, INPUT_PULLUP); // Initialize Red Button
  pinMode(BUTTON_BLACK_PIN, INPUT_PULLUP); // Initialize Black Button
  strip.begin();
  strip.setBrightness(HELLIGKEIT);
  strip.show(); // Initialize all pixels to 'off'

}

int LAUFZEIT = 120;     // 120sec: 2 minutes
int ABKLINGZEIT = 20;

void loop() {
  if(!digitalRead(BUTTON_BLACK_PIN)) {
    startTimer();
  }
}

void startTimer(){
  timeClient.update();
  long sollZeit = timeClient.getEpochTime();
  int ROT = 255;
  int GRUEN = 147;
  int BLAU = 41;
  sollZeit = sollZeit + LAUFZEIT;
  colorFill(ROT, GRUEN, BLAU);

  while (timeClient.getEpochTime() < sollZeit){
    delay(1000);
    timeClient.update();
  }
  timeClient.update();
  double i = ABKLINGZEIT / HELLIGKEIT;
  int j = 1;
  long sollZeit = timeClient.getEpochTime();
  sollZeit = sollZeit + ABKLINGZEIT;
  while (timeClient.getEpochTime() < sollZeit){
    delay(1000);
    strip.setBrightness(HELLIGKEIT - (i*j));
    j++;
  }
  strip.setBrightness(0);
}

void colorFill(int r, int g, int b) {
  for(int i=0; i < strip.numPixels(); i++) {
      strip.setPixelColor(i, strip.Color(r, g, b));
      strip.show();
  }
}
